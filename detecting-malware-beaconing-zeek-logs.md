# Module 08: Detecting Malware Beaconing (The Heartbeat)

## ðŸ“Œ Investigation Overview
Malware, such as Command & Control (C2) agents (e.g., Cobalt Strike, Sliver), must "call home" to a remote server to receive instructions. This repetitive communication is known as **Beaconing**. 

Unlike human web browsing, which is sporadic and random, malware beacons are highly consistent. In this module, we leverage **Zeek HTTP logs** and Splunk's statistical commands to identify these "heartbeats" by calculating the time variance between connections.

---

## ðŸ” The Logic: Consistency over Volume
We aren't looking for the *amount* of data sent, but the **regularity** of the intervals. 

### The Detection Strategy:
1. **Delta Calculation:** Determine the exact time difference (in seconds) between consecutive connections.
2. **Mean Averaging:** Find the average time interval for specific Source/Destination pairs.
3. **Jitter Compensation:** Attackers add "Jitter" (random delays) to stay hidden. We apply a 10% margin of error to account for this.
4. **Pattern Matching:** If >90% of connections fall within this 10% window, we have identified an automated beacon.

---

## ðŸ› ï¸ The Beaconing Hunt Query (Statistical Modeling)
This query performs real-time math on network flows to unmask C2 heartbeats.

```splunk
index="main" sourcetype="bro:http:json" 
| sort 0 _time
| streamstats current=f last(_time) as prevtime by src, dest, dest_port
| eval timedelta = _time - prevtime
| eventstats avg(timedelta) as avg, count as total by src, dest, dest_port
| eval upper=avg*1.1
| eval lower=avg*0.9
| where timedelta > lower AND timedelta < upper
| stats count, values(avg) as TimeInterval by src, dest, dest_port, total
| eval prcnt = (count/total)*100
| where prcnt > 90 AND total > 10
```
